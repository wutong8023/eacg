import os
import sys
import logging
from datetime import datetime
import io

class TeeOutput:
    """
    è‡ªå®šä¹‰è¾“å‡ºé‡å®šå‘ç±»ï¼ŒåŒæ—¶å†™å…¥æ–‡ä»¶å’Œç»ˆç«¯
    """
    def __init__(self, file_path, original_stream, encoding='utf-8'):
        self.file_path = file_path
        self.original_stream = original_stream
        self.encoding = encoding
        self.log_file = None
        self._open_log_file()
    
    def _open_log_file(self):
        """æ‰“å¼€æ—¥å¿—æ–‡ä»¶"""
        try:
            self.log_file = open(self.file_path, 'a', encoding=self.encoding, buffering=1)
        except Exception as e:
            print(f"æ— æ³•æ‰“å¼€æ—¥å¿—æ–‡ä»¶ {self.file_path}: {e}")
            self.log_file = None
    
    def write(self, text):
        """å†™å…¥æ–‡æœ¬åˆ°æ–‡ä»¶å’ŒåŸå§‹æµ"""
        # å†™å…¥åˆ°åŸå§‹æµï¼ˆç»ˆç«¯ï¼‰
        if self.original_stream:
            self.original_stream.write(text)
            self.original_stream.flush()
        
        # å†™å…¥åˆ°æ—¥å¿—æ–‡ä»¶
        if self.log_file:
            try:
                # æ·»åŠ æ—¶é—´æˆ³å‰ç¼€ï¼ˆåªå¯¹éç©ºè¡Œæ·»åŠ ï¼‰
                if text.strip():
                    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ—¶é—´æˆ³ï¼ˆé¿å…é‡å¤ï¼‰
                    if not text.startswith(timestamp[:10]):  # æ£€æŸ¥æ—¥æœŸå‰ç¼€
                        text = f"[{timestamp}] {text}"
                
                self.log_file.write(text)
                self.log_file.flush()
            except Exception as e:
                print(f"å†™å…¥æ—¥å¿—æ–‡ä»¶æ—¶å‡ºé”™: {e}")
    
    def flush(self):
        """åˆ·æ–°ç¼“å†²åŒº"""
        if self.original_stream:
            self.original_stream.flush()
        if self.log_file:
            self.log_file.flush()
    
    def close(self):
        """å…³é—­æ—¥å¿—æ–‡ä»¶"""
        if self.log_file:
            self.log_file.close()
            self.log_file = None
    
    def __getattr__(self, name):
        """ä»£ç†å…¶ä»–å±æ€§åˆ°åŸå§‹æµ"""
        return getattr(self.original_stream, name)

def setup_logging(args):
    """
    è®¾ç½®å®Œæ•´çš„æ—¥å¿—é…ç½®ï¼Œæ•è·æ‰€æœ‰ç»ˆç«¯è¾“å‡ºåˆ°å•ä¸ª.logæ–‡ä»¶
    """
    # åˆ›å»ºæ—¥å¿—æ ¹ç›®å½•
    log_base_dir = "logs"
    os.makedirs(log_base_dir, exist_ok=True)
    
    # åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„æ—¥å¿—å­ç›®å½•
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    log_dir = os.path.join(log_base_dir, f"train_lora_{args.dataset_type}_{timestamp}")
    os.makedirs(log_dir, exist_ok=True)
    
    # è®¾ç½®å®Œæ•´çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„
    log_file = os.path.join(log_dir, f"train_lora_{args.dataset_type}_complete.log")
    
    # åœ¨æ—¥å¿—æ–‡ä»¶å¼€å¤´å†™å…¥ä¼šè¯ä¿¡æ¯
    with open(log_file, 'w', encoding='utf-8') as f:
        f.write(f"=" * 80 + "\n")
        f.write(f"LoRAè®­ç»ƒå®Œæ•´æ—¥å¿— - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write(f"=" * 80 + "\n")
        f.write(f"è®­ç»ƒé…ç½®:\n")
        f.write(f"  - dataset_type: {args.dataset_type}\n")
        f.write(f"  - precision: {args.precision}\n")
        f.write(f"  - corpus_path: {args.corpus_path}\n")
        f.write(f"  - model_name: {args.model_name}\n")
        f.write(f"  - loraadaptor_save_path_base: {args.loraadaptor_save_path_base}\n")
        
        if args.benchmark_paths is not None:
            f.write(f"  - benchmark_paths: {args.benchmark_paths}\n")
        else:
            f.write(f"  - benchmark_data_path: {args.benchmark_data_path}\n")
        
        # æ·»åŠ å¤šworkerä¿¡æ¯
        if hasattr(args, 'world_size') and args.world_size > 1:
            f.write(f"  - å¤šworkeræ¨¡å¼: rank={args.rank}, world_size={args.world_size}\n")
        
        f.write(f"=" * 80 + "\n\n")
    
    # ä¿å­˜åŸå§‹çš„stdoutå’Œstderr
    original_stdout = sys.stdout
    original_stderr = sys.stderr
    
    # åˆ›å»ºé‡å®šå‘å¯¹è±¡
    stdout_tee = TeeOutput(log_file, original_stdout)
    stderr_tee = TeeOutput(log_file, original_stderr)
    
    # é‡å®šå‘stdoutå’Œstderr
    sys.stdout = stdout_tee
    sys.stderr = stderr_tee
    
    # é…ç½®loggingæ¨¡å—ä¹Ÿè¾“å‡ºåˆ°åŒä¸€ä¸ªæ–‡ä»¶
    # æ¸…é™¤ç°æœ‰çš„handlers
    for handler in logging.root.handlers[:]:
        logging.root.removeHandler(handler)
    
    # åˆ›å»ºè‡ªå®šä¹‰çš„logging handler
    class LogFileHandler(logging.Handler):
        def __init__(self, log_file_path):
            super().__init__()
            self.log_file_path = log_file_path
        
        def emit(self, record):
            try:
                msg = self.format(record)
                with open(self.log_file_path, 'a', encoding='utf-8') as f:
                    f.write(f"{msg}\n")
                    f.flush()
                # åŒæ—¶è¾“å‡ºåˆ°ç»ˆç«¯
                print(msg)
            except Exception:
                self.handleError(record)
    
    # é…ç½®logging
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        handlers=[
            LogFileHandler(log_file)
        ]
    )
    
    # è®°å½•å¯åŠ¨ä¿¡æ¯
    print(f"ğŸš€ æ—¥å¿—ç³»ç»Ÿå·²å¯åŠ¨")
    print(f"ğŸ“ å®Œæ•´æ—¥å¿—ä¿å­˜åˆ°: {log_file}")
    print(f"ğŸ“Š è®­ç»ƒé…ç½®: precision={args.precision}, dataset_type={args.dataset_type}")
    print(f"ğŸ“‚ corpus_path={args.corpus_path}")
    
    # è®°å½•benchmarkç›¸å…³ä¿¡æ¯
    if args.benchmark_paths is not None:
        print(f"ğŸ“‹ ä½¿ç”¨å¤šä¸ªbenchmarkæ–‡ä»¶: {args.benchmark_paths}")
    else:
        print(f"ğŸ“‹ ä½¿ç”¨å•ä¸ªbenchmarkæ–‡ä»¶: {args.benchmark_data_path}")
        
    print(f"ğŸ’¾ loraadaptor_save_path_base={args.loraadaptor_save_path_base}")
    print(f"ğŸ¤– model_name={args.model_name}")
    
    # å¤šworkerä¿¡æ¯
    if hasattr(args, 'world_size') and args.world_size > 1:
        print(f"ğŸ”„ å¤šworkeræ¨¡å¼: rank={args.rank}, world_size={args.world_size}")
    
    print(f"=" * 80)
    
    # å­˜å‚¨é‡å®šå‘å¯¹è±¡ï¼Œç”¨äºåç»­æ¸…ç†
    if not hasattr(setup_logging, '_redirects'):
        setup_logging._redirects = []
    setup_logging._redirects.extend([stdout_tee, stderr_tee])
    
    # å­˜å‚¨åŸå§‹æµï¼Œç”¨äºæ¢å¤
    setup_logging._original_stdout = original_stdout
    setup_logging._original_stderr = original_stderr
    
    return log_dir

def cleanup_logging():
    """
    æ¸…ç†æ—¥å¿—é‡å®šå‘ï¼Œæ¢å¤åŸå§‹çš„stdoutå’Œstderr
    """
    if hasattr(setup_logging, '_redirects'):
        # å…³é—­æ‰€æœ‰é‡å®šå‘æ–‡ä»¶
        for redirect in setup_logging._redirects:
            redirect.close()
        setup_logging._redirects.clear()
    
    # æ¢å¤åŸå§‹çš„stdoutå’Œstderr
    if hasattr(setup_logging, '_original_stdout'):
        sys.stdout = setup_logging._original_stdout
    if hasattr(setup_logging, '_original_stderr'):
        sys.stderr = setup_logging._original_stderr
    
    print("æ—¥å¿—ç³»ç»Ÿå·²å…³é—­ï¼Œè¾“å‡ºå·²æ¢å¤æ­£å¸¸")

# æ³¨å†Œæ¸…ç†å‡½æ•°ï¼Œåœ¨ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨
import atexit
atexit.register(cleanup_logging)