# LoRAè®­ç»ƒå®Œæ•´æ—¥å¿—ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

æ–°çš„æ—¥å¿—ç³»ç»Ÿå¯ä»¥æ•è·train_lora.pyè®­ç»ƒè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ç»ˆç«¯è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š
- æ‰€æœ‰printè¯­å¥çš„è¾“å‡º
- æ‰€æœ‰loggingæ¨¡å—çš„è¾“å‡º
- æ ‡å‡†è¾“å‡º(stdout)å’Œæ ‡å‡†é”™è¯¯(stderr)
- å¼‚å¸¸ä¿¡æ¯å’Œé”™è¯¯ä¿¡æ¯

æ‰€æœ‰è¾“å‡ºéƒ½ä¼šåŒæ—¶æ˜¾ç¤ºåœ¨ç»ˆç«¯å’Œä¿å­˜åˆ°ä¸€ä¸ªå®Œæ•´çš„.logæ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œè¿½è¸ªé—®é¢˜ã€‚

## ä¸»è¦åŠŸèƒ½

### 1. å®Œæ•´è¾“å‡ºæ•è·
- âœ… æ•è·æ‰€æœ‰printè¯­å¥
- âœ… æ•è·æ‰€æœ‰loggingè¾“å‡º
- âœ… æ•è·æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯
- âœ… æ•è·å¼‚å¸¸å’Œé”™è¯¯ä¿¡æ¯
- âœ… åŒæ—¶åœ¨ç»ˆç«¯æ˜¾ç¤º

### 2. æ™ºèƒ½æ—¥å¿—æ ¼å¼
- è‡ªåŠ¨æ·»åŠ æ—¶é—´æˆ³å‰ç¼€
- é¿å…é‡å¤æ—¶é—´æˆ³
- ä¼šè¯å¼€å¤´åŒ…å«è¯¦ç»†é…ç½®ä¿¡æ¯
- æ”¯æŒå¤šworkeræ¨¡å¼æ ‡è®°

### 3. æ–‡ä»¶ç®¡ç†
- è‡ªåŠ¨åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„æ—¥å¿—ç›®å½•
- ç»Ÿä¸€çš„æ—¥å¿—æ–‡ä»¶å‘½åè§„åˆ™
- ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```python
# åœ¨train_lora.pyä¸­å·²è‡ªåŠ¨é›†æˆ
python benchmark/train_lora.py --dataset_type docstring --precision bf16
```

### æ—¥å¿—æ–‡ä»¶ä½ç½®

æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ï¼š
```
logs/
â””â”€â”€ train_lora_docstring_20241213_143022/
    â””â”€â”€ train_lora_docstring_complete.log
```

æ ¼å¼è¯´æ˜ï¼š
- `logs/`: æ—¥å¿—æ ¹ç›®å½•
- `train_lora_{dataset_type}_{timestamp}/`: å¸¦æ—¶é—´æˆ³çš„ä¼šè¯ç›®å½•
- `train_lora_{dataset_type}_complete.log`: å®Œæ•´æ—¥å¿—æ–‡ä»¶

### å¤šWorkeræ¨¡å¼

åœ¨å¤šworkeræ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªworkeréƒ½ä¼šåˆ›å»ºè‡ªå·±çš„æ—¥å¿—æ–‡ä»¶ï¼š
```
logs/
â”œâ”€â”€ train_lora_docstring_20241213_143022/  # Worker 0
â”‚   â””â”€â”€ train_lora_docstring_complete.log
â”œâ”€â”€ train_lora_docstring_20241213_143025/  # Worker 1
â”‚   â””â”€â”€ train_lora_docstring_complete.log
â””â”€â”€ ...
```

## æ—¥å¿—æ–‡ä»¶æ ¼å¼

### æ–‡ä»¶å¤´ä¿¡æ¯
```
================================================================================
LoRAè®­ç»ƒå®Œæ•´æ—¥å¿— - 2024-12-13 14:30:22
================================================================================
è®­ç»ƒé…ç½®:
  - dataset_type: docstring
  - precision: bf16
  - corpus_path: /datanfs4/chenrongyi/data/docs
  - model_name: /datanfs2/chenrongyi/models/Llama-3.1-8B
  - loraadaptor_save_path_base: /datanfs2/chenrongyi/models/loraadaptors/
  - benchmark_paths: ['data/VersiBCB_Benchmark/vace_datas.json']
  - å¤šworkeræ¨¡å¼: rank=0, world_size=2
================================================================================
```

### æ—¥å¿—å†…å®¹æ ¼å¼
```
[2024-12-13 14:30:22] ğŸš€ æ—¥å¿—ç³»ç»Ÿå·²å¯åŠ¨
[2024-12-13 14:30:22] ğŸ“ å®Œæ•´æ—¥å¿—ä¿å­˜åˆ°: logs/train_lora_docstring_20241213_143022/train_lora_docstring_complete.log
[2024-12-13 14:30:22] ğŸ“Š è®­ç»ƒé…ç½®: precision=bf16, dataset_type=docstring
2024-12-13 14:30:23 - INFO - === CUDAç¯å¢ƒè¯Šæ–­ ===
2024-12-13 14:30:23 - INFO - CUDA_VISIBLE_DEVICES=0,1,2,3
[2024-12-13 14:30:23] æ­£åœ¨åŠ è½½åŒ… numpy-1.24.0 çš„è®­ç»ƒæ•°æ®...
[2024-12-13 14:30:24] æ¨¡å‹åŠ è½½å®Œæˆï¼Œå¼€å§‹è®­ç»ƒ...
```

## é«˜çº§åŠŸèƒ½

### è‡ªå®šä¹‰æ—¥å¿—çº§åˆ«
```python
import logging

# è®¾ç½®æ›´è¯¦ç»†çš„æ—¥å¿—çº§åˆ«
logging.getLogger().setLevel(logging.DEBUG)

# æ·»åŠ è‡ªå®šä¹‰æ—¥å¿—
logging.debug("è°ƒè¯•ä¿¡æ¯")
logging.info("æ™®é€šä¿¡æ¯")
logging.warning("è­¦å‘Šä¿¡æ¯")
logging.error("é”™è¯¯ä¿¡æ¯")
```

### æ‰‹åŠ¨æ¸…ç†æ—¥å¿—ç³»ç»Ÿ
```python
from utils.loraTrain.log import cleanup_logging

# æ‰‹åŠ¨æ¸…ç†ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼Œç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†ï¼‰
cleanup_logging()
```

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—è¾“å‡º
tail -f logs/train_lora_docstring_20241213_143022/train_lora_docstring_complete.log
```

### 2. æœç´¢ç‰¹å®šä¿¡æ¯
```bash
# æœç´¢é”™è¯¯ä¿¡æ¯
grep -i "error\|exception\|failed" logs/train_lora_docstring_20241213_143022/train_lora_docstring_complete.log

# æœç´¢ç‰¹å®šåŒ…çš„è®­ç»ƒä¿¡æ¯
grep -i "numpy-1.24.0" logs/train_lora_docstring_20241213_143022/train_lora_docstring_complete.log

# æœç´¢GPUä¿¡æ¯
grep -i "gpu\|cuda" logs/train_lora_docstring_20241213_143022/train_lora_docstring_complete.log
```

### 3. åˆ†æè®­ç»ƒè¿›åº¦
```bash
# æŸ¥çœ‹è®­ç»ƒç»Ÿè®¡
grep -i "è®­ç»ƒ\|è·³è¿‡\|å®Œæˆ" logs/train_lora_docstring_20241213_143022/train_lora_docstring_complete.log

# æŸ¥çœ‹æœ€åå‡ è¡Œï¼ˆè®­ç»ƒç»“æœï¼‰
tail -n 20 logs/train_lora_docstring_20241213_143022/train_lora_docstring_complete.log
```

## å¸¸è§é—®é¢˜è§£å†³

### Q: æ—¥å¿—æ–‡ä»¶è¿‡å¤§æ€ä¹ˆåŠï¼Ÿ
A: å¯ä»¥ä½¿ç”¨logrotateæˆ–æ‰‹åŠ¨æ¸…ç†æ—§æ—¥å¿—ï¼š
```bash
# æ¸…ç†7å¤©å‰çš„æ—¥å¿—
find logs/ -name "*.log" -mtime +7 -delete
```

### Q: å¦‚ä½•ç¦ç”¨æ—¥å¿—è®°å½•ï¼Ÿ
A: ä¿®æ”¹train_lora.pyä¸­çš„setup_loggingè°ƒç”¨ï¼š
```python
# ä¸´æ—¶ç¦ç”¨ï¼ˆä¸æ¨èï¼‰
# log_dir = setup_logging(args)
```

### Q: æ—¥å¿—æ–‡ä»¶æƒé™é—®é¢˜ï¼Ÿ
A: ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å’Œå†™å…¥æƒé™ï¼š
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥æƒé™
ls -la logs/
```

### Q: å¤šworkeræ¨¡å¼æ—¥å¿—æ··ä¹±ï¼Ÿ
A: æ¯ä¸ªworkerä¼šåˆ›å»ºç‹¬ç«‹çš„æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…æ··ä¹±ã€‚æŸ¥çœ‹ç‰¹å®šworkerçš„æ—¥å¿—ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰workerçš„æ—¥å¿—ç›®å½•
ls -la logs/

# æ ¹æ®æ—¶é—´æˆ³æ‰¾åˆ°å¯¹åº”çš„workeræ—¥å¿—
```

## æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**: æ—¥å¿—ç³»ç»Ÿä¼šè½»å¾®å½±å“æ€§èƒ½ï¼Œä½†å½±å“å¾ˆå°
2. **ç£ç›˜ç©ºé—´**: é•¿æ—¶é—´è®­ç»ƒä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ï¼Œæ³¨æ„æ¸…ç†
3. **ç¼–ç é—®é¢˜**: æ—¥å¿—ä½¿ç”¨UTF-8ç¼–ç ï¼Œæ”¯æŒä¸­æ–‡
4. **å¼‚å¸¸å¤„ç†**: å³ä½¿å‡ºç°å¼‚å¸¸ï¼Œæ—¥å¿—ç³»ç»Ÿä¹Ÿä¼šæ­£å¸¸å·¥ä½œ
5. **ç¨‹åºé€€å‡º**: ç¨‹åºæ­£å¸¸æˆ–å¼‚å¸¸é€€å‡ºæ—¶ä¼šè‡ªåŠ¨æ¸…ç†æ—¥å¿—ç³»ç»Ÿ

## æŠ€æœ¯å®ç°ç»†èŠ‚

### TeeOutputç±»
- å®ç°stdout/stderrçš„åŒé‡è¾“å‡º
- è‡ªåŠ¨æ·»åŠ æ—¶é—´æˆ³
- å¼‚å¸¸å®‰å…¨çš„æ–‡ä»¶æ“ä½œ

### LogFileHandlerç±»
- è‡ªå®šä¹‰logging handler
- é¿å…é‡å¤è¾“å‡º
- ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼

### æ¸…ç†æœºåˆ¶
- ä½¿ç”¨atexitæ¨¡å—æ³¨å†Œæ¸…ç†å‡½æ•°
- è‡ªåŠ¨æ¢å¤åŸå§‹è¾“å‡ºæµ
- å®‰å…¨å…³é—­æ–‡ä»¶å¥æŸ„

è¿™ä¸ªå®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿç¡®ä¿äº†è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¿¡æ¯éƒ½èƒ½è¢«å‡†ç¡®è®°å½•å’Œè¿½è¸ªï¼Œå¤§å¤§æé«˜äº†è°ƒè¯•æ•ˆç‡ã€‚ 